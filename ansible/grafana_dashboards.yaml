---
- name: Provision Grafana Dashboards
  hosts: grafana
  become: yes
  vars:
    grafana_provisioning_dir: "/opt/grafana/provisioning"
    grafana_dashboards_dir: "/opt/grafana/dashboards_json"
    
    # ID дашбордов с grafana.com
    # 1860 - Node Exporter Full (CPU, RAM, Disk, Net)
    # 15947 - NGINX Log Metrics (HTTP metrics)
    dashboard_ids: [1860, 15947]

  tasks:
    # 1. Создание структуры папок (если не созданы ранее)
    - name: Ensure directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ grafana_provisioning_dir }}/dashboards"
        - "{{ grafana_dashboards_dir }}"

    # 2. Скачивание JSON-файлов дашбордов
    - name: Download dashboard JSON from Grafana.com
      ansible.builtin.get_url:
        url: "https://grafana.com/api/dashboards/{{ item }}/revisions/1/download"
        dest: "{{ grafana_dashboards_dir }}/{{ item }}.json"
        mode: '0644'
      loop: "{{ dashboard_ids }}"

    # 3. Настройка провайдера (инструкция для Grafana, где искать файлы)
    - name: Configure Grafana dashboard provider
      ansible.builtin.copy:
        dest: "{{ grafana_provisioning_dir }}/dashboards/ansible_provider.yml"
        content: |
          apiVersion: 1
          providers:
            - name: 'Automated Dashboards'
              orgId: 1
              folder: 'Infrastructure'
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              options:
                path: /etc/grafana/dashboards_json
        mode: '0644'

    # 4. Перезапуск контейнера для применения изменений (или создание, если удален)
    - name: Restart Grafana container to load dashboards
      community.docker.docker_container:
        name: grafana
        image: grafana/grafana:latest
        state: started
        restart: yes # Принудительный перезапуск для перечитки конфигов
        published_ports: ["3000:3000"]
        volumes:
          - "{{ grafana_provisioning_dir }}:/etc/grafana/provisioning"
          - "{{ grafana_dashboards_dir }}:/etc/grafana/dashboards_json"
        env:
          GF_SECURITY_ADMIN_PASSWORD: "student"