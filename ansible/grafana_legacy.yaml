---
- name: Install and configure Grafana
  gather_facts: true
  hosts: grafana
  become: yes
  
  vars:
    grafana_version: "11.5.1"
    grafana_port: 3000
    grafana_admin_password: "student"

  tasks:
    # 1. Подготовка и установка Docker
    - name: Install prerequisite packages
      ansible.builtin.apt:
        name: [apt-transport-https, ca-certificates, curl, gnupg, lsb-release, python3-docker]
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        state: present

    - name: Install Docker Engine
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    # 2. Добавление пользователя в группу docker
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes
      when: ansible_facts['user_id'] != 'root'

    # 3. Подготовка директории и конфига
    - name: Create project directory
      ansible.builtin.file:
        path: /opt/grafana
        state: directory
        mode: '0755'

    - name: Create docker-compose.yml
      ansible.builtin.copy:
        dest: /opt/grafana/docker-compose.yml
        content: |
          services:
            grafana:
              image: grafana/grafana:{{ grafana_version }}
              container_name: grafana
              restart: always
              ports:
                - "{{ grafana_port }}:3000"
              environment:
                - GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}
              volumes:
                - grafana-data:/var/lib/grafana
          volumes:
            grafana-data:
        mode: '0644'

    # 4. Запуск
    - name: Deploy Grafana with docker compose
      community.docker.docker_compose_v2:
        project_src: /opt/grafana
        state: present
        remove_orphans: yes
    
    # 5. Проверка доступности grafana
    - name: Wait for Grafana to be ready
      ansible.builtin.uri:
        url: "http://localhost:{{ grafana_port }}/api/health"
        method: GET
        status_code: 200
      register: health_result
      until: health_result.status == 200
      retries: 12
      delay: 5
      changed_when: false

    # 6. Вывод информации
    - name: Show access URL
      ansible.builtin.debug:
        msg: "Grafana доступна по адресу http://{{ ansible_host | default(inventory_hostname) }}:{{ grafana_port }} (login: admin / pass: {{ grafana_admin_password }})"
